<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" , content="text/html; charset=UTF-8" />
    <link th:href="@{/css/user.css}" rel="stylesheet" />
    <!-- <link href="../../static/css/main.css" rel="stylesheet" /> -->
    <title>WishList Page</title>
  </head>
  <header>
    <span class="title y-middle x-start">Manager Page</span>
    <div id="buttons" class="x-end y-middle">
      <form id="show-whole-product">
        <button
          id="show-whole-product-button"
          type="button"
          class="normal-buttons"
          onclick="loadAllProductsPage()"
        >
          제품 전체 보기
        </button>
      </form>
    </div>
  </header>
  <body>
    <table id="products" class="x-middle">
      <caption class="title">
        Product List
      </caption>
      <colgroup>
        <col />
        <col />
        <col />
        <col />
        <col />
      </colgroup>
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Image</th>
          <th>Quantity</th>
          <th>Control</th>
        </tr>
      </thead>
      <tbody>
        <tr th:id="'product'+${product.id}" th:each="product : ${products}">
          <td th:text="${product.name}">Name</td>
          <td th:text="${product.price}">Price</td>
          <td th:text="${product.imageUrl}">Image</td>
          <td th:text="${product.quantity}">Quantity</td>
          <td>
            <div class="buttons">
              <button
                type="button"
                class="normal-buttons small-buttons"
                th:onclick="|decreaseWishProduct(${product.id})|"
              >
                -
              </button>
              <button
                type="button"
                class="normal-buttons small-buttons"
                th:onclick="|increaseWishProduct(${product.id})|"
              >
                +
              </button>
              <button
                type="button"
                class="delete-buttons"
                th:onclick="|deleteWishProduct(${product.id})|"
              >
                제품 삭제
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <script th:inline="javascript">
      async function requestApi(targetUrl, token, body) {
        return fetch(targetUrl, {
          method: 'post',
          headers: {
            'Content-Type': 'application/json',
            Authorization: token,
          },
          body: body,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.response) {
              return data.response;
            } else {
              alert('알 수 없는 에러가 발생했습니다.');
              return 'fail';
            }
          })
          .catch((error) => {
            throw error;
          });
      }

      async function increaseWishProduct(id) {
        const targetUrl = '/api/wishlist/increase';
        const product = document.getElementById('product' + id);
        const name = product.getElementsByTagName('td')[0].textContent;
        const price = product.getElementsByTagName('td')[1].textContent;
        const imageUrl = product.getElementsByTagName('td')[2].textContent;
        const body = JSON.stringify({
          id: id,
          name: name,
          price: price,
          imageUrl: imageUrl,
        });

        try {
          const result = await requestApi(targetUrl, /*[[${token}]]*/ '', body);
          if (result == 'success') {
            loadCurrentPage();
          }
        } catch (error) {
          console.error(error);
        }
      }

      async function decreaseWishProduct(id) {
        const targetUrl = '/api/wishlist/decrease';
        const product = document.getElementById('product' + id);
        const name = product.getElementsByTagName('td')[0].textContent;
        const price = product.getElementsByTagName('td')[1].textContent;
        const imageUrl = product.getElementsByTagName('td')[2].textContent;
        const body = JSON.stringify({
          id: id,
          name: name,
          price: price,
          imageUrl: imageUrl,
        });

        try {
          const result = await requestApi(targetUrl, /*[[${token}]]*/ '', body);
          if (result == 'success') {
            loadCurrentPage();
          }
        } catch (error) {
          console.error(error);
        }
      }

      async function deleteWishProduct(id) {
        const targetUrl = '/api/wishlist/deletion';
        const product = document.getElementById('product' + id);
        const name = product.getElementsByTagName('td')[0].textContent;
        const price = product.getElementsByTagName('td')[1].textContent;
        const imageUrl = product.getElementsByTagName('td')[2].textContent;
        const body = JSON.stringify({
          id: id,
          name: name,
          price: price,
          imageUrl: imageUrl,
        });

        try {
          const result = await requestApi(targetUrl, /*[[${token}]]*/ '', body);
          if (result == 'success') {
            loadCurrentPage();
          }
        } catch (error) {
          console.error(error);
        }
      }

      function loadPage(targetUrl, token) {
        fetch(targetUrl, {
          method: 'get',
          headers: {
            Authorization: token,
          },
        })
          .then((response) => response.text())
          .then((html) => {
            document.open();
            document.write(html);
            document.close();
          })
          .catch((error) => console.error('Error:', error));
      }

      function loadCurrentPage() {
        const targetUrl = '/user/main';
        loadPage(targetUrl, /*[[${token}]]*/ '');
      }

      function loadAllProductsPage() {
        const targetUrl = '/user/all-products';
        loadPage(targetUrl, /*[[${token}]]*/ '');
      }
    </script>
  </body>
</html>
